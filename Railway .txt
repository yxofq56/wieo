#!/bin/bash

# TVA Bot - Complete Railway Setup Script
# Ye script saari required files bana degi

echo "ðŸš€ TVA Bot Railway Setup Starting..."
echo "====================================="

# 1. Python version file
echo "ðŸ“ Creating .python-version..."
cat > .python-version << 'EOF'
3.11.0
EOF
echo "âœ… .python-version created"

# 2. Requirements file
echo "ðŸ“ Creating requirements.txt..."
cat > requirements.txt << 'EOF'
pyTelegramBotAPI==4.12.0
Flask==2.3.3
gunicorn==21.2.0
EOF
echo "âœ… requirements.txt created"

# 3. Railway JSON config
echo "ðŸ“ Creating railway.json..."
cat > railway.json << 'EOF'
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS",
    "buildCommand": "pip install -r requirements.txt"
  },
  "deploy": {
    "startCommand": "./start.sh",
    "healthcheckPath": "/health",
    "healthcheckTimeout": 100,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
EOF
echo "âœ… railway.json created"

# 4. Nixpacks config
echo "ðŸ“ Creating nixpacks.toml..."
cat > nixpacks.toml << 'EOF'
providers = ["python"]

[phases.setup]
nixPkgs = ["python311", "gcc", "sqlite"]

[phases.install]
cmds = ["pip install -r requirements.txt"]

[start]
cmd = "./start.sh"
EOF
echo "âœ… nixpacks.toml created"

# 5. Start script
echo "ðŸ“ Creating start.sh..."
cat > start.sh << 'EOF'
#!/bin/bash

echo "ðŸš€ Starting TVA Bot on Railway..."
echo "=================================="
echo "Python version: $(python --version)"
echo "Current directory: $(pwd)"
echo "Files: $(ls -la)"

# Install dependencies
echo "ðŸ“¦ Installing dependencies..."
pip install -r requirements.txt

# Check if main script exists
if [ ! -f "info.py" ]; then
    echo "âŒ info.py not found!"
    exit 1
fi

# Start the bot
echo "âœ… Starting bot..."
echo "=================================="
python info.py
EOF

chmod +x start.sh
echo "âœ… start.sh created and made executable"

# 6. Dockerfile
echo "ðŸ“ Creating Dockerfile..."
cat > Dockerfile << 'EOF'
FROM python:3.11-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    sqlite3 \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements first
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY . .

# Make start script executable
RUN chmod +x start.sh

# Expose port
EXPOSE 8080

# Run the application
CMD ["./start.sh"]
EOF
echo "âœ… Dockerfile created"

# 7. Docker ignore
echo "ðŸ“ Creating .dockerignore..."
cat > .dockerignore << 'EOF'
__pycache__
*.pyc
*.db
*.log
.git
.env
.DS_Store
EOF
echo "âœ… .dockerignore created"

# 8. Git ignore
echo "ðŸ“ Creating .gitignore..."
cat > .gitignore << 'EOF'
# Python
__pycache__/
*.py[cod]
*.so
.Python

# Database
*.db
*.db-*
*.sqlite
*.sqlite3

# Logs
*.log
bot_logs.log

# Environment
.env
.venv
venv/
ENV/

# Railway
.railway/
tmp/

# Backups
backup_*.db

# OS
.DS_Store
Thumbs.db
EOF
echo "âœ… .gitignore created"

# 9. Check if info.py exists
echo "ðŸ” Checking for info.py..."
if [ ! -f "info.py" ]; then
    echo "âš ï¸  Warning: info.py not found!"
    echo "Please make sure your bot script is named 'info.py'"
else
    echo "âœ… info.py found"
fi

# 10. Make everything executable
chmod +x start.sh
chmod +x setup_railway.sh

echo ""
echo "====================================="
echo "âœ… RAILWAY SETUP COMPLETE!"
echo "====================================="
echo ""
echo "Files created:"
ls -la | grep -E '(railway|nixpacks|Dockerfile|start|requirements|python-version|git|docker)'
echo ""
echo "ðŸ“¦ Next steps:"
echo "1. Push to GitHub:"
echo "   git add ."
echo "   git commit -m 'Railway setup'"
echo "   git push"
echo ""
echo "2. Deploy on Railway:"
echo "   - Go to https://railway.app"
echo "   - New Project â†’ Deploy from GitHub"
echo "   - Select your repository"
echo ""
echo "3. Check logs if any issues"
echo "====================================="